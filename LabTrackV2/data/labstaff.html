<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8">
    <link rel="stylesheet" href="borrowform.css">
    <title>Staff Dashboard</title>
    <style>
        .item-row { background: #444; padding: 10px; margin: 5px 0; display: flex; align-items: center; }
        .item-row input { width: auto; margin-right: 10px; transform: scale(1.5); }
        .item-row label { flex-grow: 1; font-size: 1.1em; }
        .btn-scan { background: #2196F3; font-size: 1.2em; padding: 15px; width: 100%; margin-top: 20px; }
    </style>
</head>
<body>
<div class="container">
    <h2>CATS Labmin Return Dashboard</h2>
    
    <div id="scanPanel" style="padding: 20px; text-align: center; border: 2px dashed #555;">
        <h1 style="font-size: 4em; margin: 0;">üçû</h1>
        <p id="statusText">Ready to Scan</p>
        <button class="btn-scan" onclick="manualScan()">SCAN CARD</button>
    </div>
    
    <div id="detailsPanel" style="display:none;">
        <h3>Transaction Found</h3>
        <div style="margin-bottom:15px; background: #333; padding: 10px; border-radius: 5px;">
            <strong>Student:</strong> <span id="stEmail">...</span><br>
            <span style="font-size:0.8em; color:#aaa;" id="txID"></span>
        </div>

        <p>Uncheck items that are <strong>MISSING/DAMAGED</strong>:</p>
        <div id="checklist"></div>

        <button onclick="processReturn()" style="background:#4CAF50; margin-top:20px;">CONFIRM RETURN</button>
        <button onclick="location.reload()" style="background:#777; margin-top:10px;">CANCEL</button>
    </div>
</div>

<script>
// Replace with YOUR Google Script URL
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw3LLcA5mpJ40OX8VhsnDPoDDoHdv4DnFk_Y6-A2llTfQdowBeteFuDrQMAdXXt-09R/exec";

function manualScan() {
    const btn = document.querySelector('.btn-scan');
    const status = document.getElementById('statusText');
    
    btn.disabled = true;
    btn.innerText = "Scanning...";
    status.innerText = "Hold card near reader...";

    // 1. Ask ESP32 for Card ID
    fetch('/utility/read', {method:'POST'})
    .then(r => r.json())
    .then(d => {
        if(d.content && d.content.startsWith("CATS-")) {
            loadTx(d.content);
        } else {
            // Failure or empty
            alert("No Transaction Card Found. Try again.");
            resetScanBtn();
        }
    })
    .catch(e => {
        alert("Connection Error. Check ESP32.");
        resetScanBtn();
    });
}

function resetScanBtn() {
    const btn = document.querySelector('.btn-scan');
    const status = document.getElementById('statusText');
    btn.disabled = false;
    btn.innerText = "SCAN CARD";
    status.innerText = "Ready to Scan";
}

// 2. Load Data from Google
function loadTx(uid) {
    document.getElementById('statusText').innerText = "Fetching Data...";
    
    fetch(SCRIPT_URL + "?action=get_transaction&uid=" + uid)
    .then(r => r.json())
    .then(d => {
        if(d.status != 'found') { 
            alert("Transaction ID found on card, but not in Database!"); 
            resetScanBtn(); 
            return; 
        }
        
        // Switch Views
        document.getElementById('scanPanel').style.display = 'none';
        document.getElementById('detailsPanel').style.display = 'block';
        
        // Fill Data
        document.getElementById('txID').innerText = uid;
        document.getElementById('stEmail').innerText = d.student;
        
        const list = document.getElementById('checklist');
        list.innerHTML = "";
        
        // Create Checkboxes
        d.items.split(',').forEach(item => {
            let div = document.createElement('div');
            div.className = 'item-row';
            // Checked by default = Returning Good
            div.innerHTML = `<input type="checkbox" checked value="${item.trim()}"><label>${item.trim()}</label>`;
            list.appendChild(div);
        });
    })
    .catch(e => {
        alert("Google Database Error.");
        resetScanBtn();
    });
}

// 3. Process Return
function processReturn() {
    const uid = document.getElementById('txID').innerText;
    const checkboxes = document.querySelectorAll('#checklist input');
    
    let returned = [];
    let remaining = [];
    
    checkboxes.forEach(cb => {
        if(cb.checked) returned.push(cb.value);
        else remaining.push(cb.value);
    });

    const btn = document.querySelector('button'); // The confirm button
    btn.disabled = true; btn.innerText = "Syncing...";

    fetch('/return/finalize', {
        method: 'POST',
        body: JSON.stringify({
            uid: uid,
            returned_items: returned,
            remaining_items: remaining
        })
    }).then(r => r.json()).then(d => {
        if(remaining.length > 0) {
            alert("Partial Return Saved.\nCard NOT wiped (items remain).");
        } else {
            alert("All Items Returned.\nHOLD CARD TO WIPE.");
        }
        location.reload();
    });
}
</script>
</body>
</html>