<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="borrowform.css">
</head>
<body>
<div class="container">
    <h2>CATS-LabTrack Staff Dashboard</h2>
    <div id="scan" style="border: 2px dashed #555; padding: 40px;">Waiting for Card...</div>
    
    <div id="details" style="display:none;">
        <h3 id="txID"></h3>
        <p id="stEmail"></p>
        <div id="itemsList"></div>
        <button onclick="finalize()" style="background:#4CAF50; margin-top:20px;">CONFIRM RETURN & WIPE</button>
    </div>
</div>
<script>
setInterval(() => {
    fetch('/utility/read', {method:'POST'}).then(r=>r.json()).then(d=>{
        if(d.content && d.content.startsWith("TX-") && document.getElementById('details').style.display=='none') {
            loadTx(d.content);
        }
    });
}, 2000);

function loadTx(uid) {
    document.getElementById('scan').innerText = "Loading...";
    // Replace with your Google Script URL
    fetch("https://script.google.com/macros/s/AKfycbw3LLcA5mpJ40OX8VhsnDPoDDoHdv4DnFk_Y6-A2llTfQdowBeteFuDrQMAdXXt-09R/exec?action=get_transaction&uid="+uid)
    .then(r=>r.json()).then(d=>{
        if(d.status!='not_found') {
            document.getElementById('scan').style.display='none';
            document.getElementById('details').style.display='block';
            document.getElementById('txID').innerText = d.uid;
            document.getElementById('stEmail').innerText = d.student;
            document.getElementById('itemsList').innerText = d.items; // Simplified for brevity
        }
    });
}

function finalize() {
    const uid = document.getElementById('txID').innerText;
    fetch('/return/finalize', { method: 'POST', body: JSON.stringify({uid: uid, item_statuses:[]}) })
    .then(r=>r.json()).then(d=>{
        alert("Success! Hold Card to Wipe.");
        location.reload();
    });
}
</script>
</body>
</html>