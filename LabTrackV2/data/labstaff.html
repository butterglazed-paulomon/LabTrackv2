<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="borrowform.css">
    <title>Staff Dashboard</title>
</head>
<body>
<div class="container">
    <h2>CATS-Labtrack Labmin Dashboard</h2>
    
    <div id="scanPanel" style="border: 2px dashed #555; padding: 40px; text-align: center;">
        <h1 style="font-size: 3em;">üì°</h1>
        <p>Scanning for Card...</p>
    </div>
    
    <div id="detailsPanel" style="display:none; text-align: left;">
        <h3>Transaction Found</h3>
        <div style="background:#444; padding:10px; border-radius:5px; margin-bottom:10px;">
            <strong style="color:#aaa;">ID:</strong> <span id="txID">...</span><br>
            <strong style="color:#aaa;">Student:</strong> <span id="stEmail">Loading...</span><br>
            <strong style="color:#aaa;">Items:</strong>
            <ul id="itemsList" style="padding-left: 20px; margin: 5px 0;"></ul>
        </div>
        
        <label>Inspection Result:</label>
        <select id="condition" style="width:100%; padding:10px; margin-bottom:20px;">
            <option value="Good">‚úÖ All Items Good</option>
            <option value="Damaged">‚ö†Ô∏è Damaged / Missing</option>
        </select>

        <button onclick="finalize()" style="background:#4CAF50;">CONFIRM RETURN & WIPE</button>
        <button onclick="location.reload()" style="background:#555; margin-top:10px;">CANCEL</button>
    </div>
</div>

<script>
let polling = true;

// 1. POLLING LOOP
setInterval(() => {
    if(!polling) return; // Stop asking if we found something

    fetch('/utility/read', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        // If we get a valid TX ID (length > 3 and starts with TX)
        if(data.content && data.content.startsWith("TX-")) {
            polling = false; // Stop scanning
            loadTransaction(data.content);
        }
    })
    .catch(e => console.log("Waiting..."));
}, 1000); // Check every 1 second

// 2. LOAD FROM GOOGLE
function loadTransaction(uid) {
    document.getElementById('scanPanel').style.display = 'none';
    document.getElementById('detailsPanel').style.display = 'block';
    document.getElementById('txID').innerText = uid;
    
    // Call Google Script to get details
    const scriptURL = "https://script.google.com/macros/s/AKfycbw3LLcA5mpJ40OX8VhsnDPoDDoHdv4DnFk_Y6-A2llTfQdowBeteFuDrQMAdXXt-09R/exec"; // CHECK THIS URL
    
    fetch(scriptURL + "?action=get_transaction&uid=" + uid)
    .then(r => r.json())
    .then(data => {
        if(data.status === 'not_found') {
            alert("Transaction not found in Database!");
            location.reload();
        } else {
            document.getElementById('stEmail').innerText = data.student;
            const ul = document.getElementById('itemsList');
            ul.innerHTML = "";
            // Handle comma separated items
            data.items.split(',').forEach(item => {
                let li = document.createElement("li");
                li.innerText = item.trim();
                ul.appendChild(li);
            });
        }
    });
}

// 3. FINALIZE RETURN
function finalize() {
    const uid = document.getElementById('txID').innerText;
    const cond = document.getElementById('condition').value;
    
    // Update UI
    const btn = document.querySelector('button');
    btn.disabled = true; 
    btn.innerText = "Processing & Wiping...";

    // Send to ESP32
    fetch('/return/finalize', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            uid: uid,
            item_statuses: [{id: "ALL", status: cond}] // Simplified logic
        })
    })
    .then(r => r.json())
    .then(d => {
        alert("Return Complete! Please hold card to wipe.");
        location.reload();
    });
}
</script>
</body>
</html>