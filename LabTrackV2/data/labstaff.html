<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LabTrack Staff</title>
  <link rel="stylesheet" href="labstaff.css">
  <style>
    .scan-prompt {
      text-align: center;
      padding: 40px;
      color: #aaa;
      border: 2px dashed #444;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .transaction-box {
      display: none; /* Hidden until scan */
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 8px;
    }
    .item-list {
      margin-top: 15px;
    }
    .inspection-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #444;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
    }
    .status-btns button {
      padding: 5px 10px;
      margin-left: 5px;
      opacity: 0.5;
      cursor: pointer;
    }
    .status-btns button.selected {
      opacity: 1;
      transform: scale(1.05);
      box-shadow: 0 0 5px rgba(255,255,255,0.5);
    }
    .btn-good { background: #4CAF50; color: white; border: none; }
    .btn-bad { background: #f44336; color: white; border: none; }
    
    #finalizeBtn {
      width: 100%;
      padding: 15px;
      font-size: 1.1em;
      margin-top: 20px;
      display: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>üëÆ LabTrack Staff Dashboard</h2>

  <div id="scanPrompt" class="scan-prompt">
    <h3>Waiting for Return Tap...</h3>
    <p>Ask student to tap their card on the reader.</p>
  </div>

  <div id="txDetails" class="transaction-box">
    <h3>üì¶ Return Inspection</h3>
    <p><strong>Student:</strong> <span id="stEmail">...</span></p>
    <p><strong>Transaction ID:</strong> <span id="txID">...</span></p>
    
    <div id="itemList" class="item-list"></div>

    <button id="finalizeBtn" class="accept" onclick="finalizeReturn()">CONFIRM RETURN & WIPE CARD</button>
  </div>

  <div id="statusMsg" style="text-align:center; margin-top:20px; font-weight:bold; color: #aaa;"></div>
  
  <div class="footer">
    <a href="/" style="color: #888; text-decoration: none;">&larr; Back to Borrow Form</a>
  </div>
</div>

<script>
  let currentTx = null;
  let itemStatuses = {}; 

  // Poll ESP32 every 2 seconds to see if a return card was tapped
  setInterval(checkForCard, 2000);

  function checkForCard() {
    fetch('/utility/read', { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        if (data.content && data.content.length > 0) {
          // If we found a UID and we aren't already looking at it
          if (!currentTx || currentTx.uid !== data.content) {
             loadTransaction(data.content);
          }
        }
      })
      .catch(e => console.log("Poll error", e));
  }

  function loadTransaction(uid) {
    document.getElementById('scanPrompt').style.display = 'none';
    document.getElementById('statusMsg').innerText = "Fetching details from CATS...";
    
    // Use the Google Script URL directly to fetch transaction data
    const GAS_URL = "https://script.google.com/macros/s/AKfycbw3LLcA5mpJ40OX8VhsnDPoDDoHdv4DnFk_Y6-A2llTfQdowBeteFuDrQMAdXXt-09R/exec";
    
    fetch(`${GAS_URL}?action=get_transaction&uid=${uid}`)
      .then(res => res.json())
      .then(data => {
        if (data.status === 'not_found' || !data.items) {
          document.getElementById('statusMsg').innerText = "Transaction not found or already returned.";
          setTimeout(resetUI, 3000);
          return;
        }
        
        currentTx = data; // Save data locally
        document.getElementById('txDetails').style.display = 'block';
        document.getElementById('txID').innerText = uid;
        document.getElementById('stEmail').innerText = data.student;
        document.getElementById('statusMsg').innerText = "";
        
        renderItems(data.items); 
      })
      .catch(e => {
         document.getElementById('statusMsg').innerText = "Error fetching data.";
         setTimeout(resetUI, 3000);
      });
  }

  function renderItems(itemString) {
    const list = document.getElementById('itemList');
    list.innerHTML = "";
    itemStatuses = {};

    const items = itemString.split(',').map(s => s.trim());
    items.forEach(item => {
      itemStatuses[item] = null; // Pending selection
      
      const row = document.createElement('div');
      row.className = 'inspection-row';
      row.innerHTML = `
        <span>${item}</span>
        <div class="status-btns" id="btns-${item}">
          <button class="btn-good" onclick="setStatus('${item}', 'Good')">Good</button>
          <button class="btn-bad" onclick="setStatus('${item}', 'Damaged')">Damaged</button>
          <button class="btn-bad" onclick="setStatus('${item}', 'Missing')">Missing</button>
        </div>
      `;
      list.appendChild(row);
    });

    document.getElementById('finalizeBtn').style.display = 'block';
  }

  function setStatus(item, status) {
    itemStatuses[item] = status;
    const container = document.getElementById(`btns-${item}`);
    const btns = container.getElementsByTagName('button');
    for(let b of btns) b.classList.remove('selected');
    for(let b of btns) {
        if(b.innerText === status) b.classList.add('selected');
    }
  }

  function finalizeReturn() {
    // Validate that every item has a status
    for (let [key, val] of Object.entries(itemStatuses)) {
      if (!val) {
        alert(`Please mark status for ${key}`);
        return;
      }
    }

    const btn = document.getElementById('finalizeBtn');
    btn.disabled = true;
    btn.innerText = "Processing Return...";

    const payload = {
      uid: currentTx.uid,
      type: "return_inspection",
      item_statuses: Object.keys(itemStatuses).map(k => ({ id: k, status: itemStatuses[k] }))
    };

    fetch('/return/finalize', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("‚úÖ Return Complete! Tag Wiped.");
        resetUI();
      } else {
        alert("‚ùå Error: " + data.message);
        btn.disabled = false;
        btn.innerText = "CONFIRM RETURN & WIPE CARD";
      }
    });
  }

  function resetUI() {
    currentTx = null;
    document.getElementById('txDetails').style.display = 'none';
    document.getElementById('scanPrompt').style.display = 'block';
    document.getElementById('statusMsg').innerText = "";
    document.getElementById('finalizeBtn').disabled = false;
    document.getElementById('finalizeBtn').innerText = "CONFIRM RETURN & WIPE CARD";
  }
</script>

</body>
</html>